<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CX_V2 AI 直播系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #34495e;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-dot.running {
            background-color: #2ecc71;
        }

        .status-dot.stopped {
            background-color: #e74c3c;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .btn-start {
            background-color: #2ecc71;
            color: white;
        }

        .btn-start:hover {
            background-color: #27ae60;
        }

        .btn-stop {
            background-color: #e74c3c;
            color: white;
        }

        .btn-stop:hover {
            background-color: #c0392b;
        }

        .btn-save {
            background-color: #3498db;
            color: white;
        }

        .btn-save:hover {
            background-color: #2980b9;
        }

        .btn-restart {
            background-color: #f39c12;
            color: white;
        }

        .btn-restart:hover {
            background-color: #e67e22;
        }

        .btn-melotts-start {
            background-color: #9b59b6;
            color: white;
        }

        .btn-melotts-start:hover {
            background-color: #8e44ad;
        }

        .btn-melotts-stop {
            background-color: #e67e22;
            color: white;
        }

        .btn-melotts-stop:hover {
            background-color: #d35400;
        }

        .btn-melotts-warmup {
            background-color: #1abc9c;
            color: white;
        }

        .btn-melotts-warmup:hover {
            background-color: #16a085;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .config-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .log-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry.INFO {
            color: #2ecc71;
        }

        .log-entry.WARNING {
            color: #f39c12;
        }

        .log-entry.ERROR {
            color: #e74c3c;
        }

        .log-entry.DEBUG {
            color: #3498db;
        }

        .message-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            height: 80px;
            resize: vertical;
        }

        .send-btn {
            background-color: #9b59b6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .send-btn:hover {
            background-color: #8e44ad;
        }

        .response-display {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        .melotts-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2196F3;
        }

        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .form-group.switch {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .form-group.switch label {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>晨曦V2 AI直播系统控制面板</h1>
            <p>使用 Web 界面控制和监控 晨曦V2 AI直播系统</p>
        </header>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot">●</div>
                <span id="statusText">已停止</span>
            </div>
            <div class="control-buttons">
            <button class="btn-start" id="startBtn">启动</button>
            <button class="btn-stop" id="stopBtn">停止</button>
            <button class="btn-restart" id="restartBtn">重启</button>
            <button class="btn-melotts-warmup" id="melottsWarmupBtn">预热</button>
            <button class="btn-save" id="saveBtn">保存配置</button>
        </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>系统配置</h2>
                <form class="config-form" id="configForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ollama_api_url">Ollama API URL</label>
                            <input type="text" id="ollama_api_url" name="ollama_api_url">
                        </div>
                        <div class="form-group">
                            <label for="ollama_model">辅助模型</label>
                            <input type="text" id="ollama_model" name="ollama_model">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ollama_vision_model">主模型（视觉模型）</label>
                            <input type="text" id="ollama_vision_model" name="ollama_vision_model">
                        </div>
                        <div class="form-group">
                            <label for="ollama_temperature">温度 (Temperature)</label>
                            <input type="number" id="ollama_temperature" name="ollama_temperature" step="0.1" min="0" max="2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="enable_sound_effects">启用音效</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_sound_effects" name="enable_sound_effects">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group switch">
                            <label for="enable_music">启用点歌</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_music" name="enable_music">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="enable_ai_drawing">启用AI绘画</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_ai_drawing" name="enable_ai_drawing">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group switch">
                            <label for="enable_continuous_mode">启用连续操作模式</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_continuous_mode" name="enable_continuous_mode">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="system_prompt">系统提示词</label>
                        <textarea id="system_prompt" name="system_prompt" rows="4"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_conversation_history">最大对话历史数量</label>
                            <input type="number" id="max_conversation_history" name="max_conversation_history" min="10" max="500">
                        </div>
                        <div class="form-group">
                            <label for="context_window_size">上下文窗口大小 (句数)</label>
                            <input type="number" id="context_window_size" name="context_window_size" min="1" max="50">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ollama_max_tokens">Ollama 文本模型最大 Token 数</label>
                            <input type="number" id="ollama_max_tokens" name="ollama_max_tokens" min="100" max="10000">
                        </div>
                        <div class="form-group">
                            <label for="ollama_vision_max_tokens">Ollama 视觉模型最大 Token 数</label>
                            <input type="number" id="ollama_vision_max_tokens" name="ollama_vision_max_tokens" min="100" max="10000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="context_file_path">上下文文件路径</label>
                        <input type="text" id="context_file_path" name="context_file_path">
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="enable_danmu">启用弹幕连接</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_danmu" name="enable_danmu">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="danmu_websocket_uri">弹幕 WebSocket 地址</label>
                            <input type="text" id="danmu_websocket_uri" name="danmu_websocket_uri">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="danmu_task_ids">弹幕任务 IDs（JSON 数组格式，用逗号分隔）</label>
                        <input type="text" id="danmu_task_ids" name="danmu_task_ids" placeholder='例如: "123456","789012"'>
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="auto_restart">启用自动重启</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto_restart" name="auto_restart">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="auto_restart_interval">自动重启间隔（秒）</label>
                            <input type="number" id="auto_restart_interval" name="auto_restart_interval" min="60" max="86400">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="enable_voice_recognition">启用语音识别</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_voice_recognition" name="enable_voice_recognition">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group switch">
                            <label for="voice_trigger_enabled">启用语音触发</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="voice_trigger_enabled" name="voice_trigger_enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="key_trigger_enabled">启用按键触发</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="key_trigger_enabled" name="key_trigger_enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="volume_threshold">音量阈值</label>
                            <input type="number" id="volume_threshold" name="volume_threshold" step="0.1" min="100" max="2000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="silence_threshold">静音阈值</label>
                            <input type="number" id="silence_threshold" name="silence_threshold" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label for="voice_trigger_volume">语音触发音量</label>
                            <input type="number" id="voice_trigger_volume" name="voice_trigger_volume" step="0.01" min="0.01" max="1.0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="trigger_key">触发键</label>
                            <input type="text" id="trigger_key" name="trigger_key">
                        </div>
                        <div class="form-group">
                            <label for="stop_trigger_key">停止触发键</label>
                            <input type="text" id="stop_trigger_key" name="stop_trigger_key">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="wake_word">唤醒词</label>
                            <input type="text" id="wake_word" name="wake_word">
                        </div>
                        <div class="form-group">
                            <label for="sleep_word">睡眠词</label>
                            <input type="text" id="sleep_word" name="sleep_word">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="enable_wake_sleep">启用唤醒/睡眠功能</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_wake_sleep" name="enable_wake_sleep">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group switch">
                            <label for="enable_continuous_talk">启用连续对话</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable_continuous_talk" name="enable_continuous_talk">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- MeloTTS Configuration -->
                    <div class="form-row">
                        <div class="form-group switch">
                            <label for="use_molotts">启用MeloTTS</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="use_molotts" name="use_molotts">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="melotts_api_url">MeloTTS API URL</label>
                            <input type="text" id="melotts_api_url" name="melotts_api_url">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="molotts_device">MeloTTS 设备</label>
                            <input type="text" id="molotts_device" name="molotts_device" placeholder="例如: cpu, cuda">
                        </div>
                        <div class="form-group">
                            <label for="molotts_language">MeloTTS 语言</label>
                            <input type="text" id="molotts_language" name="molotts_language" placeholder="例如: ZH, EN, JP">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="molotts_speaker">MeloTTS 说话人</label>
                            <input type="text" id="molotts_speaker" name="molotts_speaker" placeholder="例如: ZH, EN, JP">
                        </div>
                        <div class="form-group">
                            <label for="molotts_speaker_id">MeloTTS 说话人ID</label>
                            <input type="number" id="molotts_speaker_id" name="molotts_speaker_id" min="0" max="10">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="molotts_sdp_ratio">SDP 比率</label>
                            <input type="number" id="molotts_sdp_ratio" name="molotts_sdp_ratio" step="0.01" min="0" max="1">
                        </div>
                        <div class="form-group">
                            <label for="molotts_noise_scale">噪声比例</label>
                            <input type="number" id="molotts_noise_scale" name="molotts_noise_scale" step="0.01" min="0" max="2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="molotts_noise_scale_w">噪声宽度比例</label>
                            <input type="number" id="molotts_noise_scale_w" name="molotts_noise_scale_w" step="0.01" min="0" max="2">
                        </div>
                        <div class="form-group">
                            <label for="molotts_speed">语音速度</label>
                            <input type="number" id="molotts_speed" name="molotts_speed" step="0.1" min="0.1" max="3">
                        </div>
                    </div>

                    <!-- VDB数据库管理配置 -->
                    <div class="vdb-management-section">
                        <h3>VDB数据库管理</h3>
                        <div class="form-row">
                            <div class="form-group switch">
                                <label for="vdb_auto_run">启用自动数据库清理</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="vdb_auto_run" name="vdb_auto_run">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="form-group switch">
                                <label for="vdb_startup_run">启动时执行数据库清理</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="vdb_startup_run" name="vdb_startup_run">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group switch">
                                <label for="enable_llm_vdb_control">启用LLM控制VDB管理</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enable_llm_vdb_control" name="enable_llm_vdb_control">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vdb_check_interval">数据库检查间隔（分钟）</label>
                                <input type="number" id="vdb_check_interval" name="vdb_check_interval" min="5" max="10080" value="60">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="qdrant_host">Qdrant主机地址</label>
                                <input type="text" id="qdrant_host" name="qdrant_host" placeholder="localhost">
                            </div>
                            <div class="form-group">
                                <label for="qdrant_port">Qdrant端口</label>
                                <input type="number" id="qdrant_port" name="qdrant_port" min="1" max="65535" placeholder="6333">
                            </div>
                        </div>
                        <div class="vdb-actions">
                            <button class="btn-vdb-save" id="vdbSaveBtn">保存VDB配置</button>
                            <button class="btn-vdb-clean" id="vdbCleanBtn">立即执行数据库清理</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="panel">
                <h2>消息发送</h2>
                <div class="message-panel">
                    <div class="form-group">
                        <label for="messageInput">发送消息到AI系统 (绕过ASR)</label>
                        <textarea id="messageInput" class="message-input" placeholder="输入要发送给AI的消息..."></textarea>
                    </div>
                    <button class="send-btn" id="sendMessageBtn">发送消息</button>
                    <div class="form-group">
                        <label>AI系统响应</label>
                        <div id="responseDisplay" class="response-display">等待响应...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>系统日志</h2>
            <div class="log-container" id="logContainer">
                <!-- 日志将通过 WebSocket 动态添加 -->
            </div>
        </div>

        <footer>
            <p>晨曦V2 AI直播系统控制面板 v2.0</p>
        </footer>
    </div>

    <script>
        // 连接到 Socket.IO 服务器
        const socket = io();

        // DOM 元素
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const restartBtn = document.getElementById('restartBtn');
        const saveBtn = document.getElementById('saveBtn');
        const melottsStartBtn = document.getElementById('melottsStartBtn');
        const melottsStopBtn = document.getElementById('melottsStopBtn');
        const melottsWarmupBtn = document.getElementById('melottsWarmupBtn');
        const logContainer = document.getElementById('logContainer');
        const configForm = document.getElementById('configForm');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const responseDisplay = document.getElementById('responseDisplay');
        // VDB 相关元素
        const vdbSaveBtn = document.getElementById('vdbSaveBtn');
        const vdbCleanBtn = document.getElementById('vdbCleanBtn');
        const vdbAutoRun = document.getElementById('vdb_auto_run');
        const vdbStartupRun = document.getElementById('vdb_startup_run');
        const vdbCheckInterval = document.getElementById('vdb_check_interval');
        const enableLlmVdbControl = document.getElementById('enable_llm_vdb_control');

        // 状态更新处理
        socket.on('status_update', function(data) {
            updateStatus(data.running);
        });

        // 配置更新处理
        socket.on('config_update', function(data) {
            loadConfig(data);
        });

        // 日志更新处理
        socket.on('log_update', function(data) {
            addLogEntry(data);
        });

        // 更新状态显示
        function updateStatus(isRunning) {
            if (isRunning) {
                statusDot.className = 'status-dot running';
                statusText.textContent = '运行中';
            } else {
                statusDot.className = 'status-dot stopped';
                statusText.textContent = '已停止';
            }
        }

        // 加载配置到表单
        function loadConfig(config) {
            for (const [key, value] of Object.entries(config)) {
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'danmu_task_ids') {
                        // 特殊处理任务ID数组，将其转换为逗号分隔的字符串
                        if (Array.isArray(value)) {
                            element.value = value.join(',');
                        } else {
                            element.value = value;
                        }
                    } else if (element.tagName === 'SELECT') {
                        element.value = String(value);
                    } else if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }
            
            // 加载VDB配置
        fetch('/api/control/vdb', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: 'get_status' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (vdbAutoRun) vdbAutoRun.checked = data.vdb_auto_run;
                if (vdbStartupRun) vdbStartupRun.checked = data.vdb_startup_run;
                if (vdbCheckInterval) vdbCheckInterval.value = data.vdb_check_interval;
                if (enableLlmVdbControl) enableLlmVdbControl.checked = data.enable_llm_vdb_control;
                
                // 填充Qdrant配置
                if (data.qdrant_host) {
                    document.getElementById('qdrant_host').value = data.qdrant_host;
                }
                if (data.qdrant_port) {
                    document.getElementById('qdrant_port').value = data.qdrant_port;
                }
            }
        })
        .catch(error => console.error('Error loading VDB config:', error));
        }

        // 添加日志条目
        function addLogEntry(log) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.level}`;
            logEntry.textContent = `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.level}: ${log.message}`;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 按钮事件处理
        startBtn.addEventListener('click', function() {
            fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'start' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Start command sent successfully');
                } else {
                    alert('启动失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('启动命令发送失败');
            });
        });

        stopBtn.addEventListener('click', function() {
            fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'stop' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Stop command sent successfully');
                } else {
                    alert('停止失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('停止命令发送失败');
            });
        });

        restartBtn.addEventListener('click', function() {
            fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'restart' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Restart command sent successfully');
                    alert('系统已重启');
                } else {
                    alert('重启失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('重启命令发送失败');
            });
        });

        // MeloTTS 预热按钮处理
        melottsWarmupBtn.addEventListener('click', function() {
            fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'control_melotts', melotts_action: 'warmup' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('MeloTTS warmup command sent successfully');
                    alert(data.message);
                } else {
                    alert('MeloTTS预热失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('MeloTTS预热命令发送失败');
            });
        });

        saveBtn.addEventListener('click', function() {
            const formData = new FormData(configForm);
            // 处理表单数据
            const config = {};
            
            // 获取所有input元素
            const inputs = configForm.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const key = input.name;
                if (!key) return;
                
                // 特殊处理 danmu_task_ids
                if (key === 'danmu_task_ids') {
                    const value = input.value.trim();
                    if (value !== '') {
                        // 分割逗号分隔的值并清理空白
                        const taskIds = value.split(',').map(id => id.trim()).filter(id => id !== '');
                        config[key] = taskIds.length > 0 ? taskIds : ['123456'];
                    } else {
                        config[key] = ['123456']; // 默认值
                    }
                } 
                // 处理checkbox
                else if (input.type === 'checkbox') {
                    config[key] = input.checked;
                }
                // 处理其他输入类型
                else {
                    const value = input.value;
                    // 尝试转换为布尔值或数字
                    if (value === 'true') config[key] = true;
                    else if (value === 'false') config[key] = false;
                    else if (!isNaN(value) && value !== '') config[key] = Number(value);
                    else config[key] = value;
                }
            });

            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('配置已保存');
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('配置保存失败');
            });
        });
        
        // 保存VDB配置
        vdbSaveBtn.addEventListener('click', function() {
            const vdbConfig = {
                vdb_auto_run: vdbAutoRun.checked,
                vdb_startup_run: vdbStartupRun.checked,
                vdb_check_interval: Number(vdbCheckInterval.value),
                enable_llm_vdb_control: enableLlmVdbControl.checked,
                qdrant_host: document.getElementById('qdrant_host').value || 'localhost',
                qdrant_port: Number(document.getElementById('qdrant_port').value) || 6333
            };
            
            fetch('/api/control/vdb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    action: 'set_config',
                    config: vdbConfig
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('VDB配置已保存');
                } else {
                    alert('VDB配置保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('VDB配置保存失败');
            });
        });
        
        // 执行数据库手动清理
        vdbCleanBtn.addEventListener('click', function() {
            if (confirm('确定要立即执行数据库清理吗？这可能会删除过期的记录。')) {
                responseDisplay.textContent = '正在执行数据库清理...';
                
                fetch('/api/control/vdb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'manual_clean' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        responseDisplay.textContent = '数据库清理完成！';
                        alert('数据库清理成功完成');
                    } else {
                        responseDisplay.textContent = `清理失败: ${data.message}`;
                        alert('数据库清理失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    responseDisplay.textContent = '数据库清理失败';
                    alert('数据库清理请求发送失败');
                });
            }
        });

        // 发送消息按钮处理
        sendMessageBtn.addEventListener('click', function() {
            const message = messageInput.value.trim();
            if (!message) {
                alert('请输入消息内容');
                return;
            }

            responseDisplay.textContent = '正在发送消息...';

            fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'send_message',
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    responseDisplay.textContent = '消息发送成功！';
                    messageInput.value = ''; // 清空输入框
                } else {
                    responseDisplay.textContent = `发送失败: ${data.message}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                responseDisplay.textContent = '消息发送失败';
            });
        });

        // 添加按键监听功能
        let isRecording = false;
        
        // 监听键盘按键事件
        document.addEventListener('keydown', function(event) {
            // 获取配置的触发键和停止键
            const triggerKey = document.getElementById('trigger_key') ? 
                document.getElementById('trigger_key').value.toLowerCase() : 'f11';
            const stopKey = document.getElementById('stop_trigger_key') ? 
                document.getElementById('stop_trigger_key').value.toLowerCase() : 'f12';
            
            // 检查是否按下触发键
            if (event.key.toLowerCase() === triggerKey && !isRecording) {
                isRecording = true;
                console.log('开始录音键被按下');
                
                // 发送开始录音命令
                fetch('/api/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'start_recording'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('开始录音命令发送成功');
                        addLogEntry({
                            level: 'info',
                            message: '开始录音...',
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        console.error('开始录音失败:', data.message);
                        addLogEntry({
                            level: 'error',
                            message: '开始录音失败: ' + data.message,
                            timestamp: new Date().toISOString()
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLogEntry({
                        level: 'error',
                        message: '开始录音命令发送失败',
                        timestamp: new Date().toISOString()
                    });
                });
                
                event.preventDefault();
            }
            
            // 检查是否按下停止键
            if (event.key.toLowerCase() === stopKey && isRecording) {
                isRecording = false;
                console.log('停止录音键被按下');
                
                // 发送停止录音命令
                fetch('/api/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'stop_recording'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('停止录音命令发送成功');
                        addLogEntry({
                            level: 'info',
                            message: '录音已停止',
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        console.error('停止录音失败:', data.message);
                        addLogEntry({
                            level: 'error',
                            message: '停止录音失败: ' + data.message,
                            timestamp: new Date().toISOString()
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addLogEntry({
                        level: 'error',
                        message: '停止录音命令发送失败',
                        timestamp: new Date().toISOString()
                    });
                });
                
                event.preventDefault();
            }
        });

        // 页面加载时请求初始数据
        window.onload = function() {
            // 请求当前配置
            fetch('/api/config')
                .then(response => response.json())
                .then(data => loadConfig(data))
                .catch(error => console.error('Error loading config:', error));

            // 请求当前状态
            fetch('/api/status')
                .then(response => response.json())
                .then(data => updateStatus(data.running))
                .catch(error => console.error('Error loading status:', error));
        };
    </script>
</body>
</html>